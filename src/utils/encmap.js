"use strict";var EncMap={},MapConfig={url:"http://10.19.151.238:8080/geoserver/gas/ows?service=WFS",wfs:{featureNS:"gas",srsName:"EPSG:3857",featurePrefix:"gas",featureTypes:["t_CSGX_Station","t_CSGX","t_QDM_FWFW"],outputFormat:"application/json"}};EncMap.encGraphicLayer=null,EncMap.encVectorSource=null,EncMap.encDraw=null,EncMap.encHeatMap={baiduGradient:["#00f","#0ff","#0f0","#ff0","#f00"],arcgisGradient:["rgba(0, 0, 255, 0)","rgb(0, 0, 255)","rgb(255, 0, 255)","rgb(255,69, 0)"]},EncMap.encHtmlPopup=null,EncMap.encTempLayerArray=[],EncMap.encSelect=null,EncMap.Map=function(id,mapoptions,mapCompleteCallback){var me=this;this.addLayer=function(e,t){(e.get("layerId")||t)&&(e.get("layerId")?(this.encmap.addLayer(e),t&&e.set("layerId",t)):(this.encmap.addLayer(e),e.set("layerId",t)))},this.findLayerByID=function(e){for(var t=this.encmap.getLayers(),r=t.getLength(),n=0;n<r;n++)if(e===t.item(n).get("layerId"))return t.item(n);return null},this.setLayerVisible=function(e,t){e.setVisible(t)},this.findOverlayByID=function(e){return this.encmap.getOverlayById(e)},this.findOverlayByClass=function(e){for(var t=[],r=this.encmap.getOverlays().getArray(),n=this.encmap.getOverlays().getArray().length,o=0;o<n;o++)r[o]&&r[o].getElement().classList.contains(e)&&t.push(r[o]);return t},this.addOverlay=function(e,t){(e.get("layerId")||t)&&(e.get("layerId")?(this.encmap.addLayer(e),t&&e.set("layerId",t)):(this.encmap.addLayer(e),e.set("layerId",t)))},this.addLayers=function(e){},this.addArcTileGISLayer=function(e){var t=new ol.layer.Tile({extent:[-13884991,2870341,-7455066,6338219],source:new ol.source.TileArcGISRest({url:e})});this.encmap.addLayer(t)},this.removeLayer=function(e){this.encmap.removeLayer(e)},this.removeAlllayers=function(){for(var e=0;e<this.encmap.getLayers().getArray().length;e++)this.encmap.removeLayer(this.encmap.getLayers().getArray()[e])},this.removeOverlay=function(e){this.encmap.removeOverlay(e)},this.clearAllOverlays=function(){this.encmap.getOverlays().clear()},this.removeAllOverlays=function(){for(var e=this.encmap.getOverlays().getArray(),t=this.encmap.getOverlays().getArray().length,r=0;r<t;r++)e[r]&&e[r].setPosition(void 0)},this.getXY=function(r){function e(e){var t={};t.coordinate=e.coordinate,t.pixel=e.pixel,r(t)}return this.encmap.on("click",e),e},this.unGetXY=function(e){this.encmap.un("click",e)},this.removeInteraction=function(){null!=EncMap.encDraw&&(this.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null)},this.fitCenter=function(e){var t=e.getSource().getExtent();this.encmap.getView().fit(t,this.encmap.getSize())},this.showLayer=function(e){for(var t=0;t<this.encmap.getLayers().getArray().length;t++){if("VECTOR"==this.encmap.getLayers().getArray()[t].type)this.encmap.getLayers().getArray()[t].get("layerId")==e&&me.encmap.getLayers().getArray()[t].setVisible(!0);else if("TILE"==this.encmap.getLayers().getArray()[t].type){if(e==me.encmap.getLayers().getArray()[t].getSource().getParams().LAYERS)return me.encmap.getLayers().getArray()[t].setVisible(!0)}}},this.hideLayer=function(e){for(var t=0;t<this.encmap.getLayers().getArray().length;t++){if("VECTOR"==this.encmap.getLayers().getArray()[t].type)this.encmap.getLayers().getArray()[t].get("layerId")==e&&me.encmap.getLayers().getArray()[t].setVisible(!1);else if("TILE"==this.encmap.getLayers().getArray()[t].type){if(e==this.encmap.getLayers().getArray()[t].getSource().getParams().LAYERS)return me.encmap.getLayers().getArray()[t].setVisible(!1)}}},this.removeFeature=function(){null!=EncMap.encVectorSource&&EncMap.encVectorSource.clear()},this.removeFeatureInVector=function(e){e.getSource().clear()},this.switchLayerVisible=function(e){switch(e.getVisible()){case!0:e.setVisible(!1);break;case!1:e.setVisible(!0)}},this.removeLayerByAttribute=function(e,t){for(var r=EncMap.encVectorSource.getFeatures(),n=0;n<r.length;n++){r[n].getProperties().attributes[e]===t&&EncMap.encVectorSource.removeFeature(r[n])}},this.zoomAndCenter=function(e,t,r){var n=e.encmap.getView();n.setZoom(r),n.setCenter(ol.extent.getCenter(t.getGeometry().getExtent()))},this.locateByFeature=function(e,t){var r=t.getGeometry().getExtent();e.encmap.getView().fit(r)},this.pointLocate=function(e,t){var r=this.encmap.getView(),n=[e,t];r.setCenter(n),r.setZoom(17)},this.setZoom=function(e){this.encmap.getView().setZoom(e)},this.setMinZoom=function(e){this.encmap.getView().setMinZoom(e)},this.setMaxZoom=function(e){this.encmap.getView().setMaxZoom(e)},this.fitView=function(e){this.encmap.getView().fit(e)},this.getZoom=function(e){e(this.encmap.getView().getZoom())},this.zoomAndCenterByCoords=function(e,t,r,n){var o=e.encmap.getView();o.setZoom(n),o.setCenter([t,r])},this.onMapZoomEnd=function(_zoomWhere,_callback){var _map=this.encmap,currZoom=_map.getView().getZoom();_map.on("moveend",function(e){var newZoom=_map.getView().getZoom(),strWhere;currZoom!=newZoom?(strWhere=newZoom+_zoomWhere,eval(strWhere)?_callback(!0):_callback(!1)):_callback(!1)})},this.listenMapZoom=function(r){var n=this.encmap;n.on("moveend",function(e){var t=n.getView().getZoom();r(t)})},this.getMapExtent=function(){return this.encmap.getView().calculateExtent()},this.pointCursor=function(n){var o=this.encmap;o.on("pointermove",function(e){var t=o.getEventPixel(e.originalEvent),r=o.forEachFeatureAtPixel(t,function(e,t){return n?(n=n.toLocaleLowerCase(),t.get("layerId").toLocaleLowerCase()==n?e:void 0):e});o.getTargetElement().style.cursor=null==r?"auto":"pointer"})},this.getAreaCenter=function(e){for(var t=e.getSource().getFeatures(),r=[],n=0;n<t.length;n++){var o=t[n],a=ol.extent.getCenter(o.getGeometry().getExtent()),i={};i.attributes=o.getProperties(),i.attributes.x=a[0],i.attributes.y=a[1],r.push(i)}return r},this.getLayerIndex=function(e){for(var t=-1,r=this.encmap.getLayers(),n=r.getLength(),o=0;o<n;o++)if(e==r.item(o).get("layerId")){t=o;break}return t},this.setLayerIndex=function(e,t){for(var r=this.encmap.getLayers(),n=r.getLength(),o=null,a=0;a<n;a++)if(e==r.item(a).get("layerId")){o=r.getArray()[a];break}o&&(this.encmap.removeLayer(o),this.encmap.getLayers().insertAt(t,o))},this.getAllLayers=function(){for(var e=[],t=this.encmap.getLayers().getArray(),r=0;r<t.length;r++){var n=t[r].getProperties();n.layerindex=r,e.push(n)}return e},this.setProjection=function(e,t){return new ol.proj.Projection({code:e,axisOrientation:t})},this.getCurResolution=function(){return this.encmap.getView().getResolution()},this.getCurrentZoomLevel=function(){return this.encmap.getView().getZoom()},this.panTo=function(e){this.encmap.getView().setCenter([parseFloat(e[0]),parseFloat(e[1])])},function(){var e=new ol.control.ScaleLine({units:"metric"});new ol.control.Zoom;EncMap.encVectorSource=new ol.source.Vector({wrapX:!1}),EncMap.encGraphicLayer=new ol.layer.Vector({crossOrigin:"anonymous",wrapX:!1,source:EncMap.encVectorSource}),mapoptions.layer.push(EncMap.encGraphicLayer);var t={controls:ol.control.defaults({attribution:!1,zoom:!1}).extend([e]),target:id,loadTilesWhileInteracting:!0,layers:mapoptions.layer,view:new ol.View({projection:mapoptions.projection?mapoptions.projection:"EPSG:3857",center:[parseFloat(mapoptions.centerX),parseFloat(mapoptions.centerY)],zoom:Number(mapoptions.zoom),minZoom:Number(mapoptions.minZoom)?Number(mapoptions.minZoom):0,maxZoom:Number(mapoptions.maxZoom)?Number(mapoptions.maxZoom):19})};me.encmap=new ol.Map(t),mapCompleteCallback&&me.encmap.once("postrender",function(e){mapCompleteCallback(!0)})}()},EncMap.ENCLayerProvider=function(){this.getArcGISTileLayer=function(e,t,r,n){if(t){var o=new ol.layer.Tile({source:new ol.source.TileArcGISRest({url:e})});return o.set("layerId",t),o.set("attributes",n),r&&o.set("layerName",r),o}return null},this.getWMSTileLayer=function(e,t,r,n){if(r){var o=t.SRS?t.SRS:"EPSG:3857",a=null,i=(a=t.projection?t.projection:new ol.proj.get(o)).getExtent(),l=t.origin?t.origin:ol.extent.getTopLeft(i),s=[];if(t.resolutions&&0<t.resolutions.length)s=t.resolutions;else for(var c=0;c<20;c++)s[c]=0==c?Number(t.maxRatio):s[c-1]/2;var u=new ol.tilegrid.TileGrid({origin:l,resolutions:s}),m=new ol.layer.Tile({source:new ol.source.TileWMS({url:e,params:{LAYERS:t.layers,FORMAT:t.format,SRS:t.SRS},projection:a,tileGrid:u}),opacity:t.opacity?t.opacity:1,visible:!t.visible||t.visible});return m.set("layerId",r),m.set("attributes",t),n&&m.set("layerName",n),m}return null},this.getTileLayer=function(e,t,r,n,o,a,i,l){if(null==(t&&r))return null;a=a||"1=1";var s="",s=l&&l.viewparams?l.viewparams:"",c=new ol.layer.Tile({source:new ol.source.TileWMS({crossOrigin:"anonymous",url:e,wrapX:!1,cacheSize:0,params:{FORMAT:"image/png",VERSION:t,tiled:!0,STYLES:"",SRS:o||"EPSG:3857",exceptions:"application/vnd.ogc.se_inimage",LAYERS:r,tilesOrigin:"8182616.766363565,375780.81882527255",CQL_FILTER:a,viewparams:s,timeStamp:(new Date).getTime()}})});return n&&c.set("layerName",n),c.set("layerId",r),c},this.getTileLayerByParam=function(e){if(null==(e.version&&e.typeName))return null;e._cqlFilter||(e._cqlFilter="1=1"),e.viewparams||(e.viewparams="");var t=new ol.layer.Tile({source:new ol.source.TileWMS({crossOrigin:"anonymous",url:e.url,wrapX:!1,cacheSize:0,params:{FORMAT:"image/png",VERSION:e.version,tiled:!0,STYLES:"",LAYERS:e.typeName,CQL_FILTER:e._cqlFilter,viewparams:e.viewparams}}),opacity:e.opacity?e.opacity:1,visible:!e.visible||e.visible});return e.layerName&&t.set("layerName",e.layerId),t.set("attributes",e),t.set("layerId",e.typeName),t},this.getVectorLayer=function(e,t,r,n){if(null==t)return null;var o=new ol.layer.Vector({source:new ol.source.Vector({url:e,format:new ol.format.GeoJSON}),opacity:n});return r&&o.set("layerName",r),o.set("layerId",t),o},this.getVectorLayerByParam=function(e){if(null==e.url||null==e.typeName)return null;var t,r,n=e.service||"WFS",o=e.serviceVersion||"1.0.0",a=e.request||"GetFeature",i=e.typeName,l=e.outputFormat||"application%2Fjson",s=e.layerId||e.typeName,c=e.cqlFilter||"1=1",u=0<=e.opacity?e.opacity:1,m=!e.visible||e.visible,y=e.viewparams?e.viewparams:"",g=e.style;r=e.maxFeatures?(t=e.maxFeatures||"50",e.url+"?service="+n+"&version="+o+"&request="+a+"&typeName="+i+"&maxFeatures="+t+"&outputFormat="+l+"&cql_filter="+c+"&viewparams="+y):e.url+"?service="+n+"&version="+o+"&request="+a+"&typeName="+i+"&outputFormat="+l+"&cql_filter="+c+"&viewparams="+y;var f=new ol.layer.Vector({source:new ol.source.Vector({url:r,format:new ol.format.GeoJSON}),opacity:u,visible:m,style:g});return e.layerName&&f.set("layerName",e.layerName),f.set("layerId",s),f.set("attributes",e),f},this.getXYZLayer=function(e,t){return new ol.layer.Tile({source:new ol.source.XYZ({url:e}),layerId:t})},this.getTempLayer=function(e){var t=new ol.source.Vector({wrapX:!1});return new ol.layer.Vector({crossOrigin:"anonymous",source:t,opacity:e&&0<=e.opacity?e.opacity:1,visible:!e||0!=e.visible||e.visible,style:e&&e.style?e.style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgb(163,204,25)",width:5})})})},this.getTempOverlay=function(e){var t=document.getElementById(e),r=null;return t&&(r=new ol.Overlay({position:[0,0],positioning:"center-bottom",element:t})),r},this.getHeatmapLayer=function(e){var t;if(e.url)t=new ol.source.Vector({url:e.url,wrapX:!1,format:new ol.format.GeoJSON});else{if(!e.features)return null;t=new ol.source.Vector({wrapX:!1,features:e.features})}return new ol.layer.Heatmap({source:t,layerId:"heatLayer",gradient:EncMap.encHeatMap.baiduGradient,blur:15,radius:e.radius||8})},this.getBaiduMapLayer=function(e){var t,r,n,o=e.scrollWheelZoom||!0,a=new BMap.Map(e.mapdiv,{minZoom:e.minZoom,maxZoom:e.maxZoom}),i=e.zoom;switch(e.point?(t=e.point.x,r=e.point.y,n=new BMap.Point(t,r),a.centerAndZoom(n,i)):e.city&&a.centerAndZoom(e.city,i),o){case!0:a.enableScrollWheelZoom();break;case!1:a.disableScrollWheelZoom()}return a},this.getClusterLayer=function(e,t,n){for(var r=new ol.source.Vector,o=0;o<e.length;o++){var a=new ol.Feature({geometry:new ol.geom.Point(e[o])});r.addFeature(a)}var i=new ol.source.Cluster({distance:t,wrapX:!1,source:r});return new ol.layer.Vector({source:i,style:function(e){return t=n,r=e.get("features").length,t=new ol.style.Style({image:new ol.style.Circle({radius:0<=t.point.radius?t.point.radius:15,stroke:new ol.style.Stroke({color:t.point.strokeColor||"#fff"}),fill:new ol.style.Fill({color:t.point.fillColor||"#3399CC"})}),text:new ol.style.Text({font:t.text.font+" sans-serif"||"15px sans-serif",text:r.toString(),fill:new ol.style.Fill({color:t.text.textFillColor||"#fff"})})});var t,r}})},this.getProjection=function(e,t){return new ol.proj.Projection({code:e,axisOrientation:t})},this.getProjectionCode=function(e){return e.encmap.getView().getProjection().getCode()},this.getOSMLayer=function(){return new ol.layer.Tile({source:new ol.source.OSM,layerId:"OSM"})},this.getGaoDeMAP=function(){return new ol.layer.Tile({source:new ol.source.XYZ({url:"http://wprd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&style=7&x={x}&y={y}&z={z}"}),layerId:"GAODE_formal"})},this.getGaodeRemoteMap=function(){return new ol.layer.Tile({source:new ol.source.XYZ({url:"https://webst03.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}"}),layerId:"GAODE_remote"})},this.getImageWMSLayer=function(e){if(e&&e.version&&e.layerName&&e.url){var t=e,r=new ol.layer.Image({source:new ol.source.ImageWMS({ratio:t.ratio||1,url:t.url,params:{FORMAT:"image/png",VERSION:t.version,LAYERS:t.layerName,exceptions:"application/vnd.ogc.se_inimage"}})});return r.set("attributes",t),r.set("layerId",t.layerName),r}return null},this.getVecetorTileLayer=function(e){if(e&&e.version&&e.layerName&&e.url){var r=e;e.format&&r.format;var n={REQUEST:"GetTile",SERVICE:"WMTS",VERSION:"1.0.0",LAYER:r.layerName,STYLE:r.style,TILEMATRIX:r.gridsetName+":{z}",TILEMATRIXSET:r.gridsetName,FORMAT:r.format,TILECOL:"{x}",TILEROW:"{y}"},t=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgb(163,204,25)",width:5}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),o=new ol.layer.VectorTile({source:function(){var e=r.url+"?";for(var t in n)e=e+t+"="+n[t]+"&";return e=e.slice(0,-1),new ol.source.VectorTile({url:e,format:new ol.format.GeoJSON({}),projection:r.projection,tileGrid:new ol.tilegrid.WMTS({tileSize:r.tileSize,origin:r.origin,resolutions:r.resolutions,matrixIds:r.gridNames}),wrapX:!0})}(),renderMode:"hybrid",declutter:!0,style:t});return o.set("layerId",r.layerName),o.set("attributes",e),o}return null}},EncMap.ENCAttributeQuery=function(){this.accurateQuery=function(e,t,r,n){var o=e.url,a={featureNS:e.featureNS,srsName:e.srsName,featurePrefix:e.featurePrefix,featureTypes:e.featureTypes,outputFormat:e.outputFormat};a.filter=ol.format.filter.equalTo(t,r);var i=(new ol.format.WFS).writeGetFeature(a);fetch(o,{method:"POST",body:(new XMLSerializer).serializeToString(i)}).then(function(e){return e.json()}).then(function(e){var t=(new ol.format.GeoJSON).readFeatures(e);n(t)})},this.fuzzyQuery=function(e,t,r,n,o){var a=e.url,i={featureNS:e.featureNS,srsName:e.srsName,featurePrefix:e.featurePrefix,featureTypes:e.featureTypes,outputFormat:e.outputFormat};i.filter=n?ol.format.filter.between(t,r+"-01-01",r+"-12-31"):ol.format.filter.like(t,"*"+r+"*");var l=(new ol.format.WFS).writeGetFeature(i);fetch(a,{method:"POST",body:(new XMLSerializer).serializeToString(l)}).then(function(e){return e.json()}).then(function(e){var t=(new ol.format.GeoJSON).readFeatures(e);o(t)})}},EncMap.ENCCombinationQuery=function(){this.boxCombinationQuery=function(a,i,l,s){null!=EncMap.encDraw&&(a.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null),EncMap.encDraw=new ol.interaction.DragBox({style:new ol.style.Style({stroke:new ol.style.Stroke({color:[0,0,255,1]})})}),a.encmap.addInteraction(EncMap.encDraw),EncMap.encDraw.on("boxend",function(){a.encmap.removeInteraction(EncMap.encDraw);var e=EncMap.encDraw.getGeometry();EncMap.encDraw=null;var t=MapConfig.wfs,r=ol.format.filter.like(i,"*"+l+"*"),n=new ol.format.filter.Intersects("the_geom",e);t.filter=new ol.format.filter.and(r,n);var o=(new ol.format.WFS).writeGetFeature(t);fetch(MapConfig.url,{method:"POST",body:(new XMLSerializer).serializeToString(o)}).then(function(e){return e.json()}).then(function(e){var t=(new ol.format.GeoJSON).readFeatures(e);s(t)})})}},EncMap.ENCSpatialQuery=function(){this.pointSpacatialQuery=function(r,e,n){null!=EncMap.encDraw&&(r.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null),EncMap.encDraw=new ol.interaction.Select({style:new ol.style.Style({image:new ol.style.Circle({radius:.1,fill:new ol.style.Fill({color:"blue"})})}),layers:e}),r.encmap.addInteraction(EncMap.encDraw),EncMap.encDraw.on("select",function(e){r.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null;var t=e.selected[0];null==t.get("features")||null==t.get("features")?n(e.selected[0]):n(e.selected[0].getProperties().features)})},this.boxSpacatialQuery=function(n,o,a){null!=EncMap.encDraw&&(n.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null),EncMap.encDraw=new ol.interaction.DragBox({style:new ol.style.Style({stroke:new ol.style.Stroke({color:[0,0,255,1]})})}),n.encmap.addInteraction(EncMap.encDraw),EncMap.encDraw.on("boxend",function(){n.encmap.removeInteraction(EncMap.encDraw);var e=EncMap.encDraw.getGeometry();EncMap.encDraw=null;var t=o.wfs;t.filter=new ol.format.filter.Intersects("the_geom",e);var r=(new ol.format.WFS).writeGetFeature(t);fetch(o.url,{method:"POST",body:(new XMLSerializer).serializeToString(r)}).then(function(e){return e.json()}).then(function(e){var t=(new ol.format.GeoJSON).readFeatures(e);a(t)})})},this.vectorQuery=function(e,r,n){null!=EncMap.encSelect&&(e.encmap.removeInteraction(EncMap.encSelect),EncMap.encSelect=null),EncMap.encSelect=new ol.interaction.Select({style:new ol.style.Style({image:new ol.style.Circle({radius:.1,fill:new ol.style.Fill({color:"blue"})})}),filter:function(e,t){if(t)return-1!=r.indexOf(t.get("layerId"))},hitTolerance:1,handleEvent:!1}),e.encmap.addInteraction(EncMap.encSelect),EncMap.encSelect.on("select",function(e){var t;null!=e.selected[0]&&(this.getFeatures().clear(),t={},t=e.selected[0].getProperties().attributes?e.selected[0].getProperties().attributes:e.selected[0].getProperties(),"Point"==e.selected[0].getGeometry().getType()?(t.x=e.selected[0].getGeometry().getCoordinates()[0]?e.selected[0].getGeometry().getCoordinates()[0]:0,t.y=e.selected[0].getGeometry().getCoordinates()[1]?e.selected[0].getGeometry().getCoordinates()[1]:0):(t.x=e.mapBrowserEvent.coordinate[0]?e.mapBrowserEvent.coordinate[0]:0,t.y=e.mapBrowserEvent.coordinate[1]?e.mapBrowserEvent.coordinate[1]:0),n(t))})},this.destoryVectorQuery=function(e){null!=EncMap.encSelect&&(e.encmap.removeInteraction(EncMap.encSelect),EncMap.encSelect=null)},this.clearSelectedStyle=function(){null!=EncMap.encDraw&&EncMap.encDraw.getFeatures().clear()}},EncMap.ENCHighlightVector=function(){var i,l,s,c,u,m,y,g,f,p,d,h;this.setHighlightVector=function(e,t,r,n,o,a){var i={};new ol.style.Style;u=e,y=t,g=r,f=n,p=o,m=a,(d=new ol.layer.Vector({source:new ol.source.Vector,style:function(e,t){var r=t<(f||5e3)?e.get(y):"";return i[r]||(i[r]=new ol.style.Style({stroke:new ol.style.Stroke({color:g.strokecolor?g.strokecolor:"#4AF5FD",width:2}),fill:new ol.style.Fill({color:g.fillcolorrgba?g.fillcolorrgba:"rgba(33, 81, 165, 1)"})})),i[r]}})).set("layerId","highlight"),(h=new ol.layer.Vector({source:new ol.source.Vector({wrapX:!1})})).set("layerId","highlighttext"),u.encmap.getLayers().insertAt(999,d),u.encmap.getLayers().insertAt(9999,h),u.encmap.on("pointermove",c)},c=function(e){if(!e.dragging){var t=u.encmap.getEventPixel(e.originalEvent),r=u.encmap.forEachFeatureAtPixel(t,function(e){var t=function(e){for(var t=u.encmap.getLayers().getArray(),r=0;r<t.length;r++){var n=t[r].getSource();if(n instanceof ol.source.Vector){var o=n.getFeatures();if(0<o.length)for(var a=0;a<o.length;a++)if(o[a]===e)return t[r]}}return null}(e);if(t&&t.get("layerId")==m)return e});if(!r)return l&&(d.getSource().removeFeature(l),l=null),void(s&&(h.getSource().removeFeature(s),s=null));if(r!==l){if(d=u.findLayerByID("highlight"),h=u.findLayerByID("highlighttext"),l&&d&&d.getSource().removeFeature(l),s&&h&&h.getSource().removeFeature(s),r){if(!d)return;if(d.getSource().addFeature(r),!h)return;var n=ol.extent.getCenter(r.getGeometry().getExtent()),o=new ol.style.Text({font:g.font?g.font:"18px Calibri,sans-serif",text:r.get(y),fill:new ol.style.Fill({color:g.textcolor?g.textcolor:"#7bc0ff"})}),a=new ol.style.Style;a.setText(o),(s=new ol.Feature({geometry:new ol.geom.Point([n[0],n[1]])})).setStyle(a),h.getSource().addFeature(s)}l=r}p&&(i=new ol.interaction.Select({condition:ol.events.condition.click,layers:[d],style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(74, 245, 253, 1)",width:2}),fill:new ol.style.Fill({color:"rgba(33, 81, 165, 0)"})})}),u.encmap.addInteraction(i),i.on("select",function(e){null!=e.selected[0]&&(this.getFeatures().clear(),p(e.selected[0]))}))}},this.removeHighlightVector=function(e){e.encmap.un("pointermove",c);for(var t=e.encmap.getLayers().getArray(),r=e.encmap.getLayers().getArray().length-1;0<=r;r--)"highlight"!=t[r].get("layerId")&&"highlighttext"!=t[r].get("layerId")||e.encmap.removeLayer(t[r]);s=l=null,i&&(i.getFeatures().clear(),e.encmap.removeInteraction(i))},this.setHighlightByCode=function(e,t,r,c){if(t&&r&&c){var n=e.findLayerByID(r+"_highlight");n&&e.removeLayer(n);var o=new ol.layer.Vector({source:new ol.source.Vector({format:new ol.format.GeoJSON,url:t+"?service=WFS&version=1.0.0&request=GetFeature&typeName="+r+"&outputFormat=application%2Fjson"}),style:function(e,t){for(var r="",n="",o="#4AF5FD",a="grey",i=1,l={},s=0;s<c.length;s++)if(r=e.get(c[s].field).toString(),n=c[s].value.toString(),o=c[s].color,a=c[s].bordercolor,i=c[s].borderwidth,r&&n&&r==n)return l=new ol.style.Style({stroke:new ol.style.Stroke({color:a||"grey",width:i||1}),fill:new ol.style.Fill({color:o||"#4AF5FD"})}),[l]}});return e.addLayer(o,r+"_highlight"),o}}},EncMap.EncAddShapeTool=function(){this.addPoint=function(e,t,r,n){for(var o=[],a=0;a<e.length;a++){var i=new ol.Feature({geometry:new ol.geom.Point([e[a].attributes.x,e[a].attributes.y]),attributes:e[a].attributes||null});t?i.setStyle(t):i.setStyle(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:17,fill:new ol.style.Fill({color:"#ffcc33"})})})),r?r.getSource().addFeature(i):EncMap.encVectorSource.addFeature(i);var l={};l.coordinates=i.getGeometry().getCoordinates(),l.geometry=i.getProperties().geometry,l.feature=i,o.push(l)}n&&n(o)},this.addSolidline=function(e,t,r,n){for(var o=[],a=0;a<e.length;a++){var i=new ol.Feature({geometry:new ol.geom.LineString(e[a].coordinates),attributes:e[a].attributes||null});t?i.setStyle(t):i.setStyle(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:5}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})),r?r.getSource().addFeature(i):EncMap.encVectorSource.addFeature(i);var l={};l.coordinates=i.getGeometry().getCoordinates(),l.attributes=i.getProperties().attributes,l.geometry=i.getProperties().geometry,l.feature=i,o.push(l)}n&&n(o)},this.addArrowline=function(e,t,r,d,n){(d=d||{}).scale=d.scale||1,d.width=d.width||1,d.color=d.color||"#ff0000",(n=n||{}).width=n.width||1,n.color=n.color||"#ff0000";var o=new ol.Collection;o.push(new ol.Feature(new ol.geom.LineString(r)));var a=new ol.layer.Vector({name:"Vecteur",source:new ol.source.Vector({features:o}),style:function(e){var t=e.getGeometry(),f=e.getGeometry(),p=[new ol.style.Style({stroke:new ol.style.Stroke({color:n.color,width:n.width}),geometry:f})];return t.forEachSegment(function(t,r){var e,n,o,a,i,l,s,c,u,m,y,g;t[0]==r[0]&&t[1]==r[1]||(e=f.getCoordinates().findIndex(function(e){return JSON.stringify(e)==JSON.stringify(t)}),n=f.getCoordinates().findIndex(function(e){return JSON.stringify(e)==JSON.stringify(r)}),o=Math.ceil((n+e-1)/2),a=f.getCoordinates()[o],l=(i=f.getCoordinates()[o+1])[0]-a[0],s=i[1]-a[1],c=Math.atan2(s,l),u=Math.sqrt(Math.pow(Math.abs(l),2)+Math.pow(Math.abs(s),2))*d.scale,(m=new ol.geom.LineString([i,[i[0]-u,i[1]+u]])).rotate(c,i),(y=new ol.geom.LineString([i,[i[0]-u,i[1]-u]])).rotate(c,i),g=new ol.style.Stroke({color:d.color,width:d.width}),p.push(new ol.style.Style({geometry:m,stroke:g})),p.push(new ol.style.Style({geometry:y,stroke:g})))}),p}});a.set("layerId",t||"ArrowLayer"),e.encmap.addLayer(a)},this.addCircle=function(e,t,r,n,o,a){var i=new ol.Feature({geometry:new ol.geom.Circle(e,t),attributes:o||null});r?i.setStyle(r):i.setStyle(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.5)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:6}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})),n?n.getSource().addFeature(i):EncMap.encVectorSource.addFeature(i);var l={};l.center=e,l.radius=t,l.extent=i.getProperties().geometry.extent_,l.attributes=i.getProperties().attributes,l.geometry=i.getProperties().geometry,l.feature=i,a&&a(l)},this.addSquare=function(e,t,r,n,o,a){var i=new ol.geom.Circle(e,t),l=new ol.Feature({geometry:new ol.geom.Polygon.fromCircle(i,4,150),attributes:o||null});r?l.setStyle(r):l.setStyle(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.5)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:6}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})),n?n.getSource().addFeature(l):EncMap.encVectorSource.addFeature(l);var s={};s.center=e,s.radius=t;for(var c=[],u=0;u<l.getProperties().geometry.flatCoordinates.length-2;u++){var m=[];m.push(l.getProperties().geometry.flatCoordinates[u]),m.push(l.getProperties().geometry.flatCoordinates[u+1]),c.push(m),u++}s.extent=l.getProperties().geometry.extent_,s.borderPoints=c,s.attributes=l.values_.attributes,s.geometry=l.getProperties().geometry,s.feature=l,a&&a(s)},this.addRectangle=function(e,t,r,n,o){var a=new ol.Feature({geometry:new ol.geom.Polygon.fromExtent(e),attributes:n||null});t?a.setStyle(t):a.setStyle(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(33,33,33,0.5)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:4}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})),r?r.getSource().addFeature(a):EncMap.encVectorSource.addFeature(a);for(var i={},l=[],s=0;s<a.getProperties().geometry.flatCoordinates.length-2;s++){var c=[];c.push(a.getProperties().geometry.flatCoordinates[s]),c.push(a.getProperties().geometry.flatCoordinates[s+1]),l.push(c),s++}i.extent=a.getProperties().geometry.extent_,i.borderPoints=l,i.attributes=a.values_.attributes,i.geometry=a.getProperties().geometry,i.feature=a,o&&o(i)},this.addPolygon=function(e,t,r,n,o){var a=new ol.Feature({geometry:new ol.geom.Polygon([e]),attributes:n||null});t?a.setStyle(t):a.setStyle(new ol.style.Style({fill:new ol.style.Fill({color:"rgba(33,33,33,0.5)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:4}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})),r?r.getSource().addFeature(a):EncMap.encVectorSource.addFeature(a);for(var i={},l=[],s=0;s<a.getProperties().geometry.flatCoordinates.length-1;s++){var c=[];c.push(a.getProperties().geometry.flatCoordinates[s]),c.push(a.getProperties().geometry.flatCoordinates[s+1]),l.push(c),s++}i.extent=a.getProperties().geometry.extent_,i.borderPoints=l,i.attributes=a.values_.attributes,i.geometry=a.getProperties().geometry,i.feature=a,o&&o(i)},this.addMarks=function(e,t,r,n,o){var a,i=null;(n=n||EncMap.encGraphicLayer).getSource()||(a=new ol.source.Vector({wrapX:!1}),n.setSource(a));for(var l=0;l<t.length;l++){i=new ol.Feature({geometry:new ol.geom.Point([t[l].attributes.x,t[l].attributes.y]),attributes:t[l].attributes});var s,c,u=new ol.style.Style;r.src&&(s=new ol.style.Icon({src:r.src,scale:r.scale?r.scale:1,anchor:r.anchor?r.anchor:[.5,.5]}),u.setImage(s)),r.text&&(c=new ol.style.Text({font:r.font,text:t[l].attributes[r.text].toString(),fill:new ol.style.Fill({color:r.fill}),offsetX:r.offset&&r.offset[0]?r.offset[0]:0,offsetY:r.offset&&r.offset[1]?r.offset[1]:0}),u.setText(c)),i.setStyle(u),n.getSource().addFeature(i)}o&&(null!=EncMap.encDraw&&(e.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null),EncMap.encDraw=new ol.interaction.Select({condition:ol.events.condition.click,layers:[n]}),e.encmap.addInteraction(EncMap.encDraw),EncMap.encDraw.on("select",function(e){var t;null!=e.selected[0]&&(this.getFeatures().clear(),(t=e.selected[0].getProperties().attributes).x=e.selected[0].getGeometry().getCoordinates()[0]?e.selected[0].getGeometry().getCoordinates()[0]:0,t.y=e.selected[0].getGeometry().getCoordinates()[1]?e.selected[0].getGeometry().getCoordinates()[1]:0,o(t))}))},this.addMarksByOverlay=function(e,t,r,n,o){for(var a=0;a<t.length;a++){var i,l=document.getElementById(n);l.id=n,document.getElementById("overlay_"+n+a)&&(i=e.encmap.getOverlayById("overlay_"+n+a),e.encmap.removeOverlay(i));var s=document.createElement("div");s.id="overlay_"+n+a,s.style.width=r.width,s.style.height=r.height,s.attr=t[a].attributes,s.x=t[a].attributes.x,s.y=t[a].attributes.y,s.classList.add("marksOverlay"),s.classList.add(n),l.appendChild(s);var c=new ol.Overlay({id:"overlay_"+n+a,positioning:"center-center",attributes:t[a].attributes,element:document.getElementById("overlay_"+n+a),stopEvent:!1});e.encmap.addOverlay(c);var u=r.src;document.getElementById("overlay_"+n+a).style.backgroundImage="url("+u+")",c.setPosition([t[a].attributes.x,t[a].attributes.y]),o&&(document.getElementById("overlay_"+n+a).onclick=function(e){var t;e.currentTarget.attr&&((t=e.currentTarget.attr).x=e.currentTarget.attr.x?e.currentTarget.attr.x:0,t.y=e.currentTarget.attr.y?e.currentTarget.attr.y:0,o(t))})}},this.removeOverlayByClass=function(e,t){for(var r=e.encmap.getOverlays().getArray(),n=e.encmap.getOverlays().getArray().length,o=0;o<n;o++)r[o]&&r[o].getElement().classList.contains(t)&&(r[o].getElement().parentElement.outerHTML="",r[o].setPosition(void 0),r[o]=null)},this.removeOverlayById=function(e,t){for(var r=e.encmap.getOverlays().getArray(),n=e.encmap.getOverlays().getArray().length,o=0;o<n;o++)r[o]&&r[o].id==t&&(r[o].getElement().parentElement.outerHTML="",r[o].setPosition(void 0),r[o]=null)},this.addTypeFeature=function(e,t,r,n){if(0<r.getSource().getFeatures().length)r.getSource().clear();else{for(var o=0,a=0;a<EncMap.encTempLayerArray.length;a++)r.get("layerId")==EncMap.encTempLayerArray[a].get("layerId")&&o++;0==o&&(0==EncMap.encTempLayerArray.length?EncMap.encTempLayerArray.push(r):(EncMap.encTempLayerArray.push(r),EncMap.encTempLayerArray.length));for(var i=0;i<t.length;i++){var l=new ol.Feature({geometry:new ol.geom.Point([t[i].attributes.x,t[i].attributes.y]),attributes:t[i].attributes});l.setStyle(new ol.style.Style({image:new ol.style.Icon({src:t[i].imgParam.src,scale:t[i].imgParam.scale})})),r.getSource().addFeature(l)}n&&(null!=EncMap.encDraw&&(e.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null),EncMap.encDraw=new ol.interaction.Select({condition:ol.events.condition.click,layers:EncMap.encTempLayerArray}),e.encmap.addInteraction(EncMap.encDraw),EncMap.encDraw.on("select",function(e){var t;null!=e.selected[0]&&((t=e.selected[0].getProperties().attributes).x=e.selected[0].getGeometry().getCoordinates()[0]?e.selected[0].getGeometry().getCoordinates()[0]:0,t.y=e.selected[0].getGeometry().getCoordinates()[1]?e.selected[0].getGeometry().getCoordinates()[1]:0,n(t))}))}},this.addFeatures=function(e,t){e&&t&&(1==t.length?e.addFeature(t):e.addFeatures(t))},this.addFeaturesForLayer=function(e,t){e&&t&&(1==t.length?e.getSource().addFeature(t):e.getSource().addFeatures(t))},this.removeFeature=function(e,t){switch(e){case"DRAW":for(var r=0;r<t.length;r++)EncMap.encVectorSource.removeFeature(t[r]);break;default:for(var n=0;n<t.length;n++)e.getSource().removeFeature(t[n])}},this.addCspline=function(e,t,r,h,v){(h=h||{}).scale=h.scale||1,h.width=h.width||1,h.color=h.color||"#ff0000",(v=v||{}).width=v.width||1,v.color=v.color||"#ff0000";var n=new ol.Collection;n.push(new ol.Feature(new ol.geom.LineString(r)));var o=new ol.layer.Vector({name:"Vecteur",source:new ol.source.Vector({features:n}),style:function(e){var t=e.getGeometry(),p=e.getGeometry().cspline({tension:.5,pointsPerSeg:10,normalize:!1}),d=[new ol.style.Style({stroke:new ol.style.Stroke({color:v.color,width:v.width}),geometry:p}),new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:"blue",width:1}),radius:1}),geometry:null}),new ol.style.Style({image:new ol.style.Circle({stroke:new ol.style.Stroke({color:"red",width:4}),radius:2}),geometry:null})];return t.forEachSegment(function(t,r){var e,n,o,a,i,l,s,c,u,m,y,g,f;t[0]==r[0]&&t[1]==r[1]||(o=p.getCoordinates().findIndex(function(e){return JSON.stringify(e)==JSON.stringify(t)}),a=p.getCoordinates().findIndex(function(e){return JSON.stringify(e)==JSON.stringify(r)}),s=(l=o<0||a<0?(i=new ol.geom.LineString([t,r]),d.push(new ol.style.Style({geometry:i,stroke:new ol.style.Stroke({color:v.color,width:v.width})})),[((n=t)[0]+r[0])/2,(t[1]+r[1])/2]):(e=Math.ceil((a+o-1)/2),n=p.getCoordinates()[e],p.getCoordinates()[e+1]))[0]-n[0],c=l[1]-n[1],u=Math.atan2(c,s),m=Math.sqrt(Math.pow(Math.abs(s),2)+Math.pow(Math.abs(c),2))*h.scale,(y=new ol.geom.LineString([l,[l[0]-m,l[1]+m]])).rotate(u,l),(g=new ol.geom.LineString([l,[l[0]-m,l[1]-m]])).rotate(u,l),f=new ol.style.Stroke({color:h.color,width:h.width}),d.push(new ol.style.Style({geometry:y,stroke:f})),d.push(new ol.style.Style({geometry:g,stroke:f})))}),d}});o.set("layerId",t||"CsplineLayer"),e.encmap.addLayer(o)}},EncMap.EncDrawShapeTool=function(){this.drawShape=function(o,e,a,t,i,r){var n,l,s;null!=EncMap.encDraw&&(o.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null),n=t?t.getSource():EncMap.encVectorSource,"Deletes"!==e?("Square"===e?(e="Circle",l=ol.interaction.Draw.createRegularPolygon(4)):"Box"===e&&(e="LineString",s=2,l=function(e,t){t=t||new ol.geom.Polygon(null);var r=e[0],n=e[1];return t.setCoordinates([[r,[r[0],n[1]],n,[n[0],r[1]],r]]),t}),EncMap.encDraw=new ol.interaction.Draw({source:n,type:e,geometryFunction:l,maxPoints:s,freehand:r||!1}),o.encmap.addInteraction(EncMap.encDraw),EncMap.encDraw.on("drawend",function(e){if(o.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null,a&&e.feature.setStyle(a),i){var t={attributes:{}};switch(t.feature=e.feature,e.feature.getGeometry().getType()){case"Point":t.attributes.x=e.feature.getGeometry().getCoordinates()[0],t.attributes.y=e.feature.getGeometry().getCoordinates()[1];break;case"LineString":var r=e.feature.getGeometry().getCoordinates();t.points=r,t.attributes.x=(e.feature.getGeometry().getExtent()[0]+e.feature.getGeometry().getExtent()[2])/2,t.attributes.y=(e.feature.getGeometry().getExtent()[1]+e.feature.getGeometry().getExtent()[3])/2;break;case"Polygon":var n=e.feature.getGeometry().getCoordinates()[0];n.pop(),t.points=n,t.attributes.x=(e.feature.getGeometry().getExtent()[0]+e.feature.getGeometry().getExtent()[2])/2,t.attributes.y=(e.feature.getGeometry().getExtent()[1]+e.feature.getGeometry().getExtent()[3])/2;break;case"Circle":t.radius=e.feature.getGeometry().getRadius(),t.attributes.x=(e.feature.getGeometry().getExtent()[0]+e.feature.getGeometry().getExtent()[2])/2,t.attributes.y=(e.feature.getGeometry().getExtent()[1]+e.feature.getGeometry().getExtent()[3])/2}i(t)}})):n.clear()}},EncMap.ENCLayerControl=function(){function y(e,t){e.onclick=function(){e.checked?t.setVisible(!0):t.setVisible(!1)}}function g(e,t){"string"==typeof e.textContent?e.textContent=t:e.innerText=t}this.loadLayersControl=function(e,t,r){for(var n=new Array,o=new Array,a=new Array,i=document.getElementById(t),l=e.getLayers(),s=0;s<l.getLength();s++){if(n[s]=l.item(s),!n[s].get("layerId"))return;o[s]=n[s].get(r)?n[s].get(r):n[s].get("layerName"),a[s]=n[s].getVisible();var c=document.createElement("li");i.appendChild(c);var u=document.createElement("input");u.type="checkbox",u.name="layers",c.appendChild(u);var m=document.createElement("label");m.className="layer",g(m,o[s]),c.appendChild(m),a[s]&&(u.checked=!0),y(u,n[s])}}},EncMap.ENCMapDrill=function(){var s=2,n="",o="",a="",l="",c="",i="",u=null;function m(r){var n=r.getSource().on("change",function(){var e,t;"ready"===r.getSource().getState()&&(e=r.getSource().getExtent(),t=u.encmap.getView(),isFinite(e[0])&&t.fit(e),r.getSource().un(n))})}function y(e){var t=new ol.layer.Tile({source:new ol.source.TileWMS({crossOrigin:"anonymous",url:n,wrapX:!1,params:{FORMAT:"image/png",VERSION:"1.1.0",tiled:!0,STYLES:"",SRS:i,exceptions:"application/vnd.ogc.se_inimage",LAYERS:a,tilesOrigin:"8182616.766363565,375780.81882527255",viewparams:e}})});return t.set("layerId",a),t}function g(e){var t=o+"?service=WFS&version=1.0.0&request=GetFeature&typeName="+a+"&outputFormat=application%2Fjson&viewparams="+e,r=new ol.layer.Vector({source:new ol.source.Vector({url:t,format:new ol.format.GeoJSON}),opacity:0});return r.set("layerId",a),r}function f(){for(var e=u.encmap.getLayers().getArray().length-1;0<=e;e--)u.encmap.getLayers().getArray()[e].get("layerId")&&(-1<u.encmap.getLayers().getArray()[e].get("layerId").indexOf(c)||-1<u.encmap.getLayers().getArray()[e].get("layerId").indexOf(l))&&u.removeLayer(u.encmap.getLayers().getArray()[e])}this.initDrill=function(e,t,r){u=e,s=r,i=t.srs||"EPSG:3857",a=t.layerName,c=t.tileLyrId,l=t.vectorLyrId,n=t.url,o=t.url.substring(0,t.url.lastIndexOf("/wms"))+"/ows"},this.doDrill=function(e,t){if(s<t)return{level:Number(t)-1};e=e||"",f();var r=e.toString().substring(0,2*(t-1)),n=c,o=y("level:"+t+";adcode:"+r);u.addLayer(o,n);var a=l,i=g("level:"+t+";adcode:"+r);return u.addLayer(i,a),m(i),{tileLyrName:n,vectLyrName:a,level:t}},this.backDrill=function(e,t){if(t<=0)return{level:Number(t)+1};e=e||"",f();var r=e.toString().substring(0,2*(t-1)),n=c,o=y("level:"+t+";adcode:"+r);u.addLayer(o,n);var a=l,i=g("level:"+t+";adcode:"+r);return u.addLayer(i,a),m(i),{tileLyrName:n,vectLyrName:a,level:t}},this.doDrillByCQL=function(e,t){if(s<t)return{level:Number(t)-1};f();var r=e.toString().substring(0,2*(t-1)),n="adcode like '"+r+encodeURIComponent("%")+"' and level = '"+t+"'",o=e+"_tile_drill",a=y("adcode like '"+r+"%' and level = '"+t+"'");u.addLayer(a,o);var i=e+"_vector_drill",l=g(n);return u.addLayer(l,i),m(l),{tileLyrName:o,vectLyrName:i,level:t}},this.backDrillByCQL=function(e,t){if(t<=0)return{level:Number(t)+1};var r=tileCqlStr="",n=e.toString().substring(0,2*(t-1)),r="adcode like '"+n+encodeURIComponent("%")+"' and level = '"+t+"'";tileCqlStr="adcode like '"+n+"%' and level = '"+t+"'";var o=e+"_tile_drill",a=y(tileCqlStr);u.addLayer(a,o);var i=e+"_vector_drill",l=g(r);return u.addLayer(l,i),m(l),{tileLyrName:o,vectLyrName:i,level:t}}},EncMap.ENCInfowindow=function(){this.showInfowindow=function(e,t,r,n,o,a){var i,l=document.getElementById(n);document.getElementById("popup"+n)&&(i=e.encmap.getOverlayById("popup"+n),e.encmap.removeOverlay(i));var s=document.createElement("div");s.id="popup"+n,l.appendChild(s),EncMap.encHtmlPopup=new ol.Overlay({id:s.id,element:s,stopEvent:a||!1}),o instanceof HTMLElement?s.appendChild(o):s.innerHTML=o,EncMap.encHtmlPopup.setPosition([t,r]),e.encmap.addOverlay(EncMap.encHtmlPopup),EncMap.encHtmlPopup.setPositioning("bottom-center")},this.setInfowindowOffset=function(e){var t=e||[0,0];EncMap.encHtmlPopup.setOffset(t)},this.showTooltips=function(e,t,r,n,o,a){var i=document.getElementById(n);i.id=n;var l=document.createElement("div"),s=(new Date).valueOf();l.id=n+"_"+s,l.classList.add("overlayTooltipsClass"),l.classList.add(n),i.appendChild(l);var c=new ol.Overlay({id:l.id,element:l,stopEvent:a||!1});return o instanceof HTMLElement?l.appendChild(o):l.innerHTML=o,c.setPosition([t,r]),e.encmap.addOverlay(c),c.setPositioning("bottom-center"),c},this.setTooltipsOffset=function(e,t){var r=t||[0,0];e.setOffset(r)},this.hideTooltipsByClass=function(e,t){for(var r=e.encmap.getOverlays().getArray(),n=e.encmap.getOverlays().getArray().length,o=0;o<n;o++)r[o]&&r[o].getElement().classList.contains(t)&&(r[o].getElement().parentElement.outerHTML="",r[o].setPosition(void 0),r[o]=null)},this.hideInfowindow=function(){EncMap.encHtmlPopup&&(EncMap.encHtmlPopup.setPosition(void 0),EncMap.encHtmlPopup=null)},this.hideTooltips=function(e){for(var t=e.encmap.getOverlays().getArray(),r=e.encmap.getOverlays().getArray().length,n=0;n<r;n++)t[n]&&t[n].getElement().classList.contains("overlayTooltipsClass")&&(t[n].getElement().parentElement.outerHTML="",t[n].setPosition(void 0),t[n]=null)},this.hideTooltipsById=function(e,t){for(var r=e.encmap.getOverlays().getArray(),n=e.encmap.getOverlays().getArray().length,o=0;o<n;o++)r[o]&&r[o].id==t&&(r[o].getElement().parentElement.outerHTML="",r[o].setPosition(void 0),r[o]=null)},this.hideTooltipsByClass=function(e,t){for(var r=e.encmap.getOverlays().getArray(),n=e.encmap.getOverlays().getArray().length,o=0;o<n;o++)r[o]&&r[o].getElement().classList.contains(t)&&(r[o].getElement().parentElement.outerHTML="",r[o].setPosition(void 0),r[o]=null)}},EncMap.EncOptShapeTool=function(){var c=void 0,u=EncMap.encHtmlPopup,m=null;this.measureLength=function(e){return e.getLength()},this.measureArea=function(e){return e.getArea()},this.calculateAll=function(e){for(var t=0,r=e.getSource().getFeatures(),n=r.length,o=0;o<n;o++){t+=r[o].values_.st_length_}return t},this.changeHeatMapRadius=function(e,t){null==t&&(t=8),e.setRadius(t)},this.dynamicLengthMeasure=function(o,a,i,l){function s(e,t,r){return null!=t&&null!=t||(t={}),c.className=t.className||"ol-overlay-container ol-selectable",c.id="measureLength_DIV",e=new ol.Overlay({element:c,id:"measureLength_DIV",offset:t.offset||[0,-15],positioning:t.positioning||"bottom-center"}),r.encmap.addOverlay(e),e}c=document.createElement("div"),null!=EncMap.encDraw&&(o.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null),EncMap.encDraw=a?new ol.interaction.Draw({source:EncMap.encVectorSource,type:"LineString",freehand:!1,style:a}):new ol.interaction.Draw({source:EncMap.encVectorSource,type:"LineString",freehand:!1}),o.encmap.addInteraction(EncMap.encDraw),EncMap.encDraw.on("drawstart",function(e){a&&e.feature.setStyle(a),u=s(u,i,o),m=e.feature;var n=e.coordinate;m.getGeometry().on("change",function(e){var t=e.target,r=100<(r=t.getLength())?Math.round(r/1e3*100)/100+" km":Math.round(100*r)/100+" m";n=t.getLastCoordinate(),c.innerHTML=r,u.setPosition(n)})}),EncMap.encDraw.on("drawend",function(e){o.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null,a&&e.feature.setStyle(a),u=s(u,i,o),m=e.feature;var t,r=100<(r=e.feature.getGeometry().getLength())?Math.round(r/1e3*100)/100+" km":Math.round(100*r)/100+" m",n=e.feature.getGeometry().getLastCoordinate();c.innerHTML=r,u.setPosition(n),l&&((t={}).feature=e.feature,t.length=r,l(t))})},this.dynamicAreaMeasure=function(o,a,i,l){function s(e,t,r){return null!=t&&null!=t||(t={}),c.className=t.className||"ol-overlay-container ol-selectable",c.id="measureArea_DIV",e=new ol.Overlay({id:"measureArea_DIV",element:c,offset:t.offset||[0,-15],positioning:t.positioning||"bottom-center"}),r.encmap.addOverlay(e),e}c=document.createElement("div"),null!=EncMap.encDraw&&(o.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null),EncMap.encDraw=a?new ol.interaction.Draw({source:EncMap.encVectorSource,type:"Polygon",freehand:!1,style:a}):new ol.interaction.Draw({source:EncMap.encVectorSource,type:"Polygon",freehand:!1}),o.encmap.addInteraction(EncMap.encDraw),EncMap.encDraw.on("drawstart",function(e){a&&e.feature.setStyle(a),u=s(u,i,o),m=e.feature;var n=e.coordinate;m.getGeometry().on("change",function(e){var t=e.target,r=1e4<(r=t.getArea())?Math.round(r/1e6*100)/100+" km<sup>2</sup>":Math.round(100*r)/100+" m<sup>2</sup>";n=t.getLastCoordinate(),c.innerHTML=r,u.setPosition(n)})}),EncMap.encDraw.on("drawend",function(e){o.encmap.removeInteraction(EncMap.encDraw),EncMap.encDraw=null,a&&e.feature.setStyle(a),u=s(u,i,o),m=e.feature;var t,r=1e4<(r=e.feature.getGeometry().getArea())?Math.round(r/1e6*100)/100+" km<sup>2</sup>":Math.round(100*r)/100+" m<sup>2</sup>",n=e.feature.getGeometry().getLastCoordinate();c.innerHTML=r,u.setPosition(n),l&&((t={}).feature=e.feature,t.length=r,l(t))})},this.dragFeature=function(r,n){var t=null;r.encmap.on("pointerdrag",function(e){t=r.encmap.getFeaturesAtPixel(e.pixel,function(e){return e})});var o=new ol.interaction.Translate({features:t});r.encmap.addInteraction(o),o.on("translateend",function(e){var t;n&&((t={}).features=e.features,t.coordinate=e.coordinate,n(t)),r.encmap.removeInteraction(o)})},this.getMouseHover=function(r,n,o){function e(e){var t=r.encmap.forEachFeatureAtPixel(e.pixel,function(e,t){return!o||o&&o.layers&&-1!=o.layers.indexOf(t.get("layerId"))?e:void 0});n(t||"")}return r.encmap.on("pointermove",e),e},this.removeMouseHover=function(e,t){e.encmap.un("pointermove",t)},this.webMercatorToWGS84=function(e,t){return t=t/20037508.34*180,{lng:e=e/20037508.34*180,lat:t=180/Math.PI*(2*Math.atan(Math.exp(t*Math.PI/180))-Math.PI/2)}},this.WGS84ToWebMercator=function(e,t){return{lng:e=20037508.34*e/180,lat:t=20037508.34*(t=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180))/180}},this.WebMercatorToBaidu=function(e,t){e=e/20037508.34*180;var r=t/20037508.34*180;t=180/Math.PI*(2*Math.atan(Math.exp(r*Math.PI/180))-Math.PI/2);var n=52.35987755982988,o=Math.sqrt(e*e+t*t)+2e-5*Math.sin(t*n),a=Math.atan2(t,e)+3e-6*Math.cos(e*n);return{x:e=o*Math.cos(a)+.0065,y:t=o*Math.sin(a)+.006}},this.WGS84ToBaidu=function(e,t){e=(e=20037508.34*e/180)/20037508.34*180;var r=(t=20037508.34*(t=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180))/180)/20037508.34*180;t=180/Math.PI*(2*Math.atan(Math.exp(r*Math.PI/180))-Math.PI/2);var n=52.35987755982988,o=Math.sqrt(e*e+t*t)+2e-5*Math.sin(t*n),a=Math.atan2(t,e)+3e-6*Math.cos(e*n);return{x:e=o*Math.cos(a)+.0065,y:t=o*Math.sin(a)+.006}},this.pixelToCoordinate=function(e,t,r){var n=e.encmap.getSize()[0],o=e.encmap.getSize()[1],a=e.encmap.getView().calculateExtent(),i=a[2],l=a[0],s=a[3];return{lng:t*(n/(3600*(i-l)))/3600+l,lat:s-r*(o/(3600*(s-a[1])))/3600}}},EncMap.ENCFlashMap=function(){this.setFlashMap=function(e,t,r,n,o){function a(e){for(var t=[],r=0;r<e.length;r++)t.push({name:e[r].attributes.name,value:[e[r].attributes.x,e[r].attributes.y,e[r].attributes.value],attributes:e[r].attributes});return t}var i=r,l=n&&n.scale?n.scale:1,s=0<=n.topNum?n.topNum:5,c={tooltip:{trigger:"item",formatter:function(e){return e.data.name+"ï¼š"+e.data.value[2]},show:0!=o||o},openlayers:{},series:[{type:"scatter",data:a(i),symbolSize:function(e){return 1e4<=e[2]?100*l:1e3<=e[2]?80*l:500<=e[2]?70*l:100<=e[2]?60*l:10<=e[2]?50*l:40*l},label:{normal:{formatter:"{b}",position:"right",show:!1},emphasis:{show:!0}},itemStyle:{normal:{color:n.otherColor?n.otherColor:"#ddb926"}}},{type:"effectScatter",data:a(i.sort(function(e,t){return t.attributes.value-e.attributes.value}).slice(0,s)),symbolSize:function(e){return 1e4<=e[2]?100*l:1e3<=e[2]?80*l:500<=e[2]?70*l:100<=e[2]?60*l:10<=e[2]?50*l:40*l},showEffectOn:"render",rippleEffect:{brushType:"stroke"},hoverAnimation:!0,label:{normal:{formatter:"{b}",position:"right",show:!0}},itemStyle:{normal:{color:n.topColor?n.topColor:"#ff0000",shadowBlur:10,shadowColor:"#333"}},zlevel:1}]},u=new ol3Echarts(c,{id:"flashmap",target:".ol-overlaycontainer",source:t||"EPSG:4326",destination:"",hideOnMoving:!0,forcedRerender:!1,forcedPrecomposeRerender:!1});return u.appendTo(e.encmap),u},this.removeFlashMap=function(e){e&&(e.remove(),e=null)},this.on=function(e,t,r){return e.$chart.on(t,r)},this.off=function(e,t,r){e.$chart.off(t,r)}},EncMap.ENCRoadLineShow=function(){var g,f,p,d,h,v,w,S,M,E=!0,b=0,r=this.speed,C=[],x=[],L=!1;function I(e,t,r){null==r&&(r=1),r-=.5;for(var n=25*Math.abs(r),o=e[0],a=e[1],i=(t[0]-o)/n,l=(t[1]-a)/n,s=0;s<=n;){var c=o+s*i,u=a+s*l;C.push([c,u]),s++}}this.initRoad=function(e,t,r,n,o,a,i,l,s){if(f=e,h=r,w=o,S=a,C=[],x=n,L=i,M=s,d=(p=t).get("layerId")||"animationLineLayer",v=h.get("layerId")||"animationPointLayer",t.set("layerId",d),r.set("layerId",v),0!=n.length){g&&clearInterval(g),null!=f.findLayerByID(d)&&f.encmap.removeLayer(f.findLayerByID(d)),null!=f.findLayerByID(v)&&f.encmap.removeLayer(f.findLayerByID(v)),E=!0;for(var c=b=0;c<n.length-1;c++)I(n[c],n[c+1]);var u,m=f.findLayerByID("animationLineLayer"),y=f.findLayerByID("animationPointLayer");null!=m?null!=m.getSource()&&m.getSource().clear():f.encmap.addLayer(t),null!=y?null!=y.getSource()&&y.getSource().clear():f.encmap.addLayer(r),l&&(u=new ol.interaction.Select({condition:ol.events.condition.click,layers:[t]}),f.encmap.addInteraction(u),u.on("select",function(e){if(null!=e.selected[0]){this.getFeatures().clear(),b=e.selected[0].get("arrIndex"),p.getSource().clear();for(var t=0;t<=b-1;t++){var r=new ol.Feature({geometry:new ol.geom.LineString([C[t],C[t+1]])});r.set("arrIndex",t),r.setStyle(w),p.getSource().addFeature(r)}var n=new ol.Feature({geometry:new ol.geom.Point(C[b])});n.setStyle(S),h.getSource().clear(),h.getSource().addFeature(n)}}))}},this.getRoadLineLayer=function(e,t,r){var n=new ol.geom.LineString(t),o=[new ol.Feature({type:"route",geometry:n})],a=new ol.source.Vector({features:o}),i=new ol.layer.Vector({source:a,style:r}),l=i.getSource().getExtent();return null!=l&&e.encmap.getView().fit(l),i},this.play=function(e){var t;L&&(t=new ol.Feature({geometry:new ol.geom.LineString(x)}),f.encmap.getView().fit(t.getGeometry().getExtent())),g&&(clearInterval(g),null!=p.getSource()&&p.getSource().clear(),null!=h.getSource()&&h.getSource().clear(),b=0),r=(r=Number(e))||40,g=setInterval(function(){if(E){if(b>C.length-2)return clearInterval(g),void(M&&M());var e=new ol.Feature({geometry:new ol.geom.LineString([C[b],C[++b]])});e.set("arrIndex",b),e.setStyle(w),p.getSource().addFeature(e);var t=new ol.Feature({geometry:new ol.geom.Point(C[b])});t.setStyle(S),h.getSource().clear(),h.getSource().addFeature(t)}},r)},this.restart=function(e){clearInterval(g),E=!(b=0),e&&(r=e),this.play(r)},this.paused=function(){return g?E=!E:null},this.faster=function(e){return clearInterval(g),e=e||1,E=!(g=null),10<r&&(r-=e),this.play(r),r},this.slower=function(e){return clearInterval(g),E=!(g=null),r+=e=e||1,this.play(r),r}},EncMap.EncGeometryProvider=function(){this.getPoints=function(e){var t=[];if(0!=e.length){for(var r=0;r<e.length;r++)t.push(new ol.Feature({geometry:new ol.geom.Point([e[r].attributes.x,e[r].attributes.y]),attributes:e[r].attributes}));return t}},this.getPolyline=function(e){var t=[];if(!(e.length<2)){for(var r=[],n=0;n<e.length;n++)r.push([e[n].attributes.x,e[n].attributes.y]);return t.push(new ol.Feature({geometry:new ol.geom.LineString(r)})),t}},this.getPolygon=function(e){var t=[];if(!(e.length<3)){for(var r=[],n=0;n<e.length;n++)r.push([e[n].attributes.x,e[n].attributes.y]);return t.push(new ol.Feature({geometry:new ol.geom.Polygon(r)})),t}}},EncMap.ENCStyle=function(){this.setStrokeStyle=function(e){var t=new ol.style.Style({stroke:new ol.style.Stroke({width:0<=e.width?e.width:1,color:e.color||"#000000",lineCap:e.lineCap||"round",lineJoin:e.lineJoin||"round",lineDash:e.lineDash||void 0,lineDashOffset:e.lineDashOffset||0,miterLimit:e.miterLimit||10})});return e.styleName&&(t.styleName=e.styleName),t},this.setIconStyle=function(e){var t=new ol.style.Style({image:new ol.style.Icon({anchor:e.anchor||[.5,.5],src:e.src,img:e.img,anchorOrigin:e.anchorOrigin||"top-left",anchorXUnits:e.anchorXUnits||"fraction",anchorYUnits:e.anchorYUnits||"fraction",offset:e.offset||[0,0],offsetOrigin:e.offsetOrigin||"top-left",opacity:0<=e.opacity?e.opacity:1,scale:0<=e.scale?e.scale:1,rotateWithView:e.rotateWithView||!1,rotation:e.rotation||0})});return e.styleName&&(t.styleName=e.styleName),t},this.setCircleStyle=function(e){var t=new ol.style.Style({image:new ol.style.Circle({radius:0<=e.radius?e.radius:10,fill:new ol.style.Fill({color:e.fillColor||"#FF0000"}),stroke:new ol.style.Stroke({color:e.strokeColor||"#000000",width:0<=e.strokeWidth?e.strokeWidth:1,lineCap:e.strokeLineCap||"round",lineJoin:e.strokeLineJoin||"round",lineDash:e.strokeLinedash||void 0,lineDashOffset:e.strokeLineDashOffset||0,miterLimit:e.strokeMiterLimit||10})})});return e.styleName&&(t.styleName=e.styleName),t},this.setImageTextStyle=function(e,t){if(e.src)return new ol.style.Style({image:new ol.style.Icon({src:e.src,anchor:e.anchor,scale:e.scale,offset:e.offset}),text:new ol.style.Text({font:e.font,text:t,fill:new ol.style.Fill({color:e.fill})})})},this.setTextStyle=function(e){return new ol.style.Style({text:new ol.style.Text({font:e.font||"10px sans-serif",text:e.text,fill:new ol.style.Fill({color:e.textFillColor||"ï¼ƒ333"})})})},this.setFeatureStyle=function(e,t){e.setStyle(t)},this.getFeatureStyle=function(e){return e.getStyle()},this.setStyles=function(e){var t=[],r=void 0,n=void 0,o=void 0,a=void 0,i=void 0;return e.text&&(i=new ol.style.Text({font:e.text.font||"10px sans-serif",text:e.text.text||"",textAlign:e.text.textAlign||"center",textBaseline:e.text.textBaseline||"middle",rotation:e.text.rotation||0,offsetX:e.text.offsetX||0,offsetY:e.text.offsetY||0,fill:new ol.style.Fill({color:e.text.textFillColor||"ï¼ƒ333"}),stroke:new ol.style.Stroke({color:e.text.textOutlineColor||[0,0,0,0],width:0<=e.text.textOutlineWidth?e.text.textOutlineWidth:1})})),e.point&&(r=new ol.style.Style({image:new ol.style.Circle({radius:e.point.radius||10,fill:new ol.style.Fill({color:e.point.fillColor||"#FF0000"}),stroke:new ol.style.Stroke({color:e.point.strokeColor||"#000000",width:0<=e.point.strokeWidth?e.point.strokeWidth:1})}),text:i}),t.push(r)),e.polyline&&(n=new ol.style.Style({stroke:new ol.style.Stroke({width:0<=e.polyline.width?e.polyline.width:1,color:e.polyline.color||"#000000",lineCap:e.polyline.lineCap||"round",lineDash:e.polyline.lineDash||void 0,lineDashOffset:e.polyline.lineDashOffset||0}),text:i}),t.push(n)),e.polygon&&(o=new ol.style.Style({fill:new ol.style.Fill({color:e.polygon.fillColor||null}),stroke:new ol.style.Stroke({color:e.polygon.strokeColor||null,width:0<=e.polygon.strokeWidth?e.polygon.strokeWidth:1}),text:i}),t.push(o)),e.icon&&(a=new ol.style.Style({image:new ol.style.Icon({anchor:e.icon.anchor||[.5,.5],src:e.icon.src||"",img:e.icon.img||null,anchorOrigin:e.icon.anchorOrigin||"top-left",anchorXUnits:e.icon.anchorXUnits||"fraction",anchorYUnits:e.icon.anchorYUnits||"fraction",offset:e.icon.offset||[0,0],offsetOrigin:e.icon.offsetOrigin||"top-left",opacity:0<=e.icon.opacity?e.icon.opacity:1,scale:0<=e.icon.scale?e.icon.scale:1,rotateWithView:e.icon.rotateWithView||!1,rotation:e.icon.rotation||0}),text:i}),t.push(a)),t},this.setHTML_MapBackGroundStyle=function(e){var t=e.encmap.getTarget();return document.getElementById(t).style}},EncMap.ENCFlylines=function(){this.setFlylines=function(e,t,i,r,n){var o,a,l,s=new ol3Echarts((o=n&&n.pieColor?n.pieColor:["#a6c84c","#ffa022","#46bee9"],a=[],l=n&&0<=n.scale?n.scale:1,r.forEach(function(e,t){a.push({name:e[0],type:"lines",zlevel:1,effect:{show:!0,period:6,trailLength:.7,color:"#fff",symbolSize:3},lineStyle:{normal:{color:o[t%o.length],width:0,curveness:.2}},data:c(e[1])},{name:e[0],type:"lines",zlevel:2,effect:{show:!1,period:6,trailLength:0,symbol:"path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z",symbolSize:15},lineStyle:{normal:{color:n&&n.lineColor?n.lineColor:o[t%o.length],width:n&&0<=n.lineWidth?n.lineWidth:1,opacity:.4,curveness:.2}},data:c(e[1])},{name:e[0],type:"effectScatter",coordinateSystem:"geo",zlevel:3,rippleEffect:{brushType:"stroke"},label:{normal:{show:!0,position:"right",formatter:function(e){return e.data.name+"ï¼š"+e.data.value[2]},color:o[t%o.length],textStyle:{fontSize:n&&n.fontSize?n.fontSize:10}}},symbolSize:function(e){return 1e4<=e[2]?100*l:1e3<=e[2]?80*l:500<=e[2]?70*l:100<=e[2]?60*l:10<=e[2]?50*l:40*l},itemStyle:{normal:{color:o[t%o.length]}},data:e[1].map(function(e){return{fromname:e[0].name,name:e[1].name,value:i[e[1].code].concat([e[1].value])}})},{name:e[1][0][0]?e[1][0][0].name:e[0],type:"scatter",coordinateSystem:"geo",zlevel:4,rippleEffect:{brushType:"stroke"},symbolSize:function(){return 0<=n.targetSize?n.targetSize:10},itemStyle:{normal:{color:o[t%o.length]}},data:e[1].map(function(e){return{fromname:e[1].name,name:e[0].name,value:i[e[0].code].concat([e[0].value])}})})}),{tooltip:{trigger:"item",formatter:function(e){return e.data&&e.data.value&&e.data.value[2]&&e.seriesName!=e.data.name?e.data.fromname+"=>"+e.data.name+"ï¼š"+e.data.value[2]:""}},series:a}),{source:t||"EPSG:4326"});function c(e){for(var t=[],r=0;r<e.length;r++){var n=e[r],o=i[n[0].code],a=i[n[1].code];o&&a&&t.push({fromName:n[0].name,fromCode:n[0].code,toName:n[1].name,toCode:n[1].code,coords:[o,a]})}return t}return s.appendTo(e.encmap),s},this.setFlylines_In=function(e,t,i,r,n){var o,a,l,s=new ol3Echarts((o=n&&n.pieColor?n.pieColor:["#a6c84c","#ffa022","#46bee9"],a=n&&0<=n.scale?n.scale:1,l=[],r.forEach(function(e,t){l.push({name:e[0],type:"lines",zlevel:1,effect:{show:!0,period:6,trailLength:.7,color:"#fff",symbolSize:3},lineStyle:{normal:{color:o[t%o.length],width:0,curveness:.2}},data:c(e[1])},{name:e[0],type:"lines",zlevel:2,effect:{show:!1,period:6,trailLength:0,symbol:"path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z",symbolSize:15},lineStyle:{normal:{color:n&&n.lineColor?n.lineColor:o[t%o.length],width:n&&0<=n.lineWidth?n.lineWidth:1,opacity:.4,curveness:.2}},data:c(e[1])},{name:e[1][0][0]?e[1][0][0].name:e[0],type:"effectScatter",coordinateSystem:"geo",zlevel:3,rippleEffect:{brushType:"stroke"},label:{normal:{show:!0,position:"right",formatter:function(e){return e.data.fromname+"ï¼š"+e.data.value[2]},color:o[t%o.length],textStyle:{fontSize:n&&0<=n.fontSize?n.fontSize:10}}},symbolSize:function(e){return 1e4<=e[2]?100*a:1e3<=e[2]?80*a:500<=e[2]?70*a:100<=e[2]?60*a:10<=e[2]?50*a:40*a},itemStyle:{normal:{color:o[t%o.length]}},data:e[1].map(function(e){return{fromname:e[0].name,name:e[1].name,value:i[e[0].code].concat([e[0].value])}})},{name:e[1][0][1]?e[1][0][1].name:e[0],type:"scatter",coordinateSystem:"geo",zlevel:4,rippleEffect:{brushType:"stroke"},symbolSize:function(){return 0<=n.targetSize?n.targetSize:10},itemStyle:{normal:{color:o[t%o.length]}},data:e[1].map(function(e){return{fromname:e[0].name,name:e[1].name,value:i[e[1].code].concat([e[1].value])}})})}),{tooltip:{trigger:"item",formatter:function(e){return e.seriesName==e.data.name?"":e.data&&e.data.value?e.data.fromname+"=>"+e.data.name+"ï¼š"+e.data.value[2]:void 0}},series:l}),{source:t||"EPSG:4326"});function c(e){for(var t=[],r=0;r<e.length;r++){var n=e[r],o=i[n[0].code],a=i[n[1].code];o&&a&&t.push({fromName:n[0].name,fromCode:n[0].code,toName:n[1].name,toCode:n[1].code,coords:[o,a]})}return t}return s.appendTo(e.encmap),s},this.removeFlylines=function(e){e&&(e.remove(),e=null)}},EncMap.ENCThirdPartyProviderQuery=function(){this.baiduAutoCompleteQuery=function(e,o,t,n){var r=t||e.getCurrentCity(),a=e,i=new BMap.Autocomplete({input:o,location:r});function l(e){return document.getElementById(e)}i.addEventListener("onhighlight",function(e){var t="",r=e.fromitem.value,n="";-1<e.fromitem.index&&(n=r.province+r.city+r.district+r.street+r.business),t="FromItem<br />index = "+e.fromitem.index+"<br />value = "+n,n="",-1<e.toitem.index&&(n=(r=e.toitem.value).province+r.city+r.district+r.street+r.business),t+="<br />ToItem<br />index = "+e.toitem.index+"<br />value = "+n,l(o).innerHTML=t}),i.addEventListener("onconfirm",function(e){var t=e.item.value,r=t.province+t.city+t.district+t.street+t.business;l(o).innerHTML="onconfirm<br />index = "+e.item.index+"<br />myValue = "+r,function(c,e,m){for(var t=c.getOverlays(),r=0;r<t.length;r++)c.removeOverlay(t[r]);var y=new BMap.LocalSearch(c,{onSearchComplete:function(){var e=y.getResults().getPoi(0).point;c.centerAndZoom(e,18);var u=new BMap.Marker(e);c.addOverlay(u),u.enableDragging(),u.addEventListener("dragend",function(e){var t=e.point;u.setPosition(t);var r=52.35987755982988,n=t.lng-.0065,o=t.lat-.006,a=Math.sqrt(n*n+o*o)-2e-5*Math.sin(o*r),i=Math.atan2(o,n)-3e-6*Math.cos(n*r),l=a*Math.cos(i),s=a*Math.sin(i);t.lng=l*Math.PI/180*6378137;var c=s*Math.PI/180;return t.lat=3189068.5*Math.log((1+Math.sin(c))/(1-Math.sin(c))),m(t)}),c.addEventListener("click",function(e){var t=new BMap.Point(e.point.lng,e.point.lat);u.setPosition(t);var r=52.35987755982988,n=t.lng-.0065,o=t.lat-.006,a=Math.sqrt(n*n+o*o)-2e-5*Math.sin(o*r),i=Math.atan2(o,n)-3e-6*Math.cos(n*r),l=a*Math.cos(i),s=a*Math.sin(i);t.lng=l*Math.PI/180*6378137;var c=s*Math.PI/180;return t.lat=3189068.5*Math.log((1+Math.sin(c))/(1-Math.sin(c))),m(t)});var t=52.35987755982988,r=e.lng-.0065,n=e.lat-.006,o=Math.sqrt(r*r+n*n)-2e-5*Math.sin(n*t),a=Math.atan2(n,r)-3e-6*Math.cos(r*t),i=o*Math.cos(a),l=o*Math.sin(a);e.lng=i*Math.PI/180*6378137;var s=l*Math.PI/180;return e.lat=3189068.5*Math.log((1+Math.sin(s))/(1-Math.sin(s))),m(e)}});y.search(e)}(a,r,n)})},this.baiduQueryAddress=function(e,t,i,l){var s=new BMap.LocalSearch(e);s.search(t);var c=[];s.setSearchCompleteCallback(function(e){if(s.getStatus()==BMAP_STATUS_SUCCESS){var t=function(e){var t=52.35987755982988,r=e.lng-.0065,n=e.lat-.006,o=Math.sqrt(r*r+n*n)-2e-5*Math.sin(n*t),a=Math.atan2(n,r)-3e-6*Math.cos(r*t),i=o*Math.cos(a),l=o*Math.sin(a);e.lng=i*Math.PI/180*6378137;var s=l*Math.PI/180;return e.lat=3189068.5*Math.log((1+Math.sin(s))/(1-Math.sin(s))),e};if(0==i){var r={lng:e.getPoi(0).point.lng,lat:e.getPoi(0).point.lat};s.getResults().Pq[0].lnglat=t(r),c.push(e.getPoi(0))}else{var n=e.getNumPages(),o=e.getPageIndex();if(!(o<n-1)){for(a=0;a<e.getCurrentNumPois();a++){r={lng:e.getPoi(a).point.lng,lat:e.getPoi(a).point.lat};e.getPoi(a).lnglat=t(r),c.push(e.getPoi(a))}return l(c)}for(var a=0;a<e.getCurrentNumPois();a++){var r={lng:e.getPoi(a).point.lng,lat:e.getPoi(a).point.lat};e.getPoi(a).lnglat=t(r),c.push(e.getPoi(a))}s.gotoPage(o+1)}}})},this.baiduAddClickPoint=function(e,t,r,m,n){for(var o=e.getOverlays(),a=0;a<o.length;a++)e.removeOverlay(o[a]);var i=new BMap.Point(t,r),y=new BMap.Marker(i);e.addOverlay(y),y.enableDragging(),y.setPosition(i);var l=52.35987755982988,s=t-.0065,c=r-.006,u=Math.sqrt(s*s+c*c)-2e-5*Math.sin(c*l),g=Math.atan2(c,s)-3e-6*Math.cos(s*l),f=u*Math.cos(g),p=u*Math.sin(g);t=f*Math.PI/180*6378137;var d=p*Math.PI/180;r=3189068.5*Math.log((1+Math.sin(d))/(1-Math.sin(d))),y.addEventListener("dragend",function(e){var t=e.point;y.setPosition(t);var r=52.35987755982988,n=t.lng-.0065,o=t.lat-.006,a=Math.sqrt(n*n+o*o)-2e-5*Math.sin(o*r),i=Math.atan2(o,n)-3e-6*Math.cos(n*r),l=a*Math.cos(i),s=a*Math.sin(i);t.lng=l*Math.PI/180*6378137;var c=s*Math.PI/180;t.lat=3189068.5*Math.log((1+Math.sin(c))/(1-Math.sin(c)));var u=[];u.push(t.lng,t.lat),m(u)}),n([t,r])},this.baiduReLocattion=function(e,t,r){var n=function(e,t){e=e/20037508.34*180;var r=t/20037508.34*180;t=180/Math.PI*(2*Math.atan(Math.exp(r*Math.PI/180))-Math.PI/2);var n=52.35987755982988,o=Math.sqrt(e*e+t*t)+2e-5*Math.sin(t*n),a=Math.atan2(t,e)+3e-6*Math.cos(e*n);return e=o*Math.cos(a)+.0065,t=o*Math.sin(a)+.006,{x:e,y:t}}(t,r),o=new BMap.Point(n.x,n.y);e.centerAndZoom(o,18);var a=new BMap.Marker(o);e.addOverlay(a),e.panTo(o);a=new BMap.Marker(o);e.addOverlay(a),a.setPosition(o)},this.baiduClearMarker=function(e){for(var t=e.getOverlays(),r=0;r<t.length;r++)e.removeOverlay(t[r])},this.matchAddressFromBaiDu=function(e,t,r){var n=new BMap.Point(e,t);(new BMap.Geocoder).getLocation(n,function(e){r(e)})},this.matchAddressFromWGS84=function(e,t,r){var n=new BMap.Point(e,t),o=new BMap.Convertor,a=[];a.push(n),o.translate(a,3,5,function(e){0===e.status&&(new BMap.Geocoder).getLocation(e.points[0],function(e){r(e)})})},this.matchAddressFromWebMercator=function(e,t,r){e=e/20037508.34*180,t=t/20037508.34*180,t=180/Math.PI*(2*Math.atan(Math.exp(t*Math.PI/180))-Math.PI/2);var n=new BMap.Point(e,t),o=new BMap.Convertor,a=[];a.push(n),o.translate(a,3,5,function(e){0===e.status&&(new BMap.Geocoder).getLocation(e.points[0],function(e){r(e)})})}},EncMap.ENCLayerDefinitionProvider=function(){this.setLayerDefinition=function(e,t,r,n){switch(r){case"wfs":case"WFS":var o,a=t.getSource().getUrl();-1<n.indexOf("%")&&(n=n.replace(/%/g,"%25")),0<=a.indexOf("&CQL_FILTER=")&&(o=a.indexOf("&CQL_FILTER="),a=a.slice(0,o+1));var i=a+"&CQL_FILTER=("+n+")",l=t.get("layerId");e.encmap.removeLayer(t);var s=new ol.layer.Vector({source:new ol.source.Vector({url:i,format:new ol.format.GeoJSON})});s.set("layerId",l),e.encmap.addLayer(s);break;case"wms":case"WMS":var c=t.getSource().getParams();c.CQL_FILTER=n;var u=t.getSource().getUrls()[0],l=t.get("layerId");e.encmap.removeLayer(t);var m=new ol.layer.Tile({source:new ol.source.TileWMS({crossOrigin:"anonymous",url:u,wrapX:!1,params:c})});m.set("layerId",l),e.encmap.addLayer(m)}}},EncMap.ENCPie=function(){this.setPie=function(e,t,r){for(var n=[],o=0;o<r.length;o++)n.push({name:"è¯¦ç»†ä¿¡æ¯",type:"pie",radius:30,coordinates:[r[o].attributes.x,r[o].attributes.y],data:r[o].attributes.items});var a=new ol3Echarts({tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},series:n,itemStyle:{color:function(e){return e.data.color}}},{source:t||"EPSG:4326"});return a.appendTo(e.encmap),a},this.removePie=function(e){e&&(e.remove(),e=null)}},EncMap.ENCBar=function(){this.setBar=function(e,t,r,n,o){for(var a={color:["#3398DB"],grid:[],xAxis:[],yAxis:[],series:[]},i=[],l=0,s=0;s<r.length;s++){for(var c=[],u=0;u<r[s].attributes.items.length;u++){var m={name:r[s].attributes.items[u].name,value:r[s].attributes.items[u].value,attributes:r[s].attributes};c.push(m),l<m.value&&(l=m.value)}i.push({name:"è¯¦ç»†ä¿¡æ¯",type:"bar",barWidth:n.series[0].barWidth,itemStyle:n.series[0].itemStyle,xAxisIndex:s,yAxisIndex:s,coordinates:[r[s].attributes.x,r[s].attributes.y],data:c})}"value"!=n.xAxis.type||n.xAxis.max?"value"!=n.yAxis.type||n.yAxis.max||(n.yAxis.max=l):n.xAxis.max=l,i.forEach(function(e,t){a.series.push(e),a.grid[t]=JSON.parse(JSON.stringify(n.grid));var r={gridIndex:t};a.xAxis[t]=JSON.parse(JSON.stringify(Object.assign(n.xAxis,r))),a.yAxis[t]=JSON.parse(JSON.stringify(Object.assign(n.yAxis,r)))}),a.color=n.color,n.tooltip&&(a.tooltip=n.tooltip),n.legend&&(a.legend=n.legend);var y=JSON.parse(JSON.stringify(Object.assign(o,{source:t||"EPSG:4326"}))),g=new ol3Echarts(a,y);return g.appendTo(e.encmap),g},this.on=function(e,t,r){return e.$chart.on(t,r)},this.on=function(e,t,r,n){return r&&null!=r&&""!=r?e.$chart.on(t,r,n):e.$chart.on(t,n)},this.off=function(e,t,r){e.$chart.off(t,r)},this.removeBar=function(e){e&&(e.remove(),e=null)}},EncMap.ENCUniqueValueRenderer=function(){this.setUniqueValueRenderer=function(e,t,r,l,n,o,a){var s,i,c;t&&(s=[{value:1e3,color:"#BD1316"},{value:500,color:"#E64B45"},{value:1e4,color:"#7F1100"},{value:100,color:"#FF8C71"},{value:10,color:"#FDD2A0"},{value:0,color:"#FFF2CF"}],n&&(s=n.sort(function(e,t){return t.value-e.value})),i=new ol.layer.Vector({source:new ol.source.Vector({format:new ol.format.GeoJSON,wrapX:!1,url:t+"?service=WFS&version=1.0.0&request=GetFeature&typeName="+r+"&outputFormat=application%2Fjson"}),style:function(e,t){var r=e.get("adcode"),n=(e.get("name"),l.filter(function(e){if(e.attributes.code==r)return e.attributes.value})),o=0;0<n.length&&(o=Number(n[0].attributes.value));for(var a=null,i=0;i<s.length;i++)if(o>=s[i].value){a=new ol.style.Style({stroke:new ol.style.Stroke({color:"grey",width:1}),fill:new ol.style.Fill({color:s[i].color})});break}return a=a||new ol.style.Style({stroke:new ol.style.Stroke({color:"grey",width:1}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 1)"})}),[a]}}),a.layerId?e.addLayer(i,a.layerId):e.addLayer(i,"uniqueValueRenderer"),o&&(c=new ol.interaction.Select({condition:ol.events.condition.click,layers:[i],style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(74, 245, 253, 1)",width:2}),fill:new ol.style.Fill({color:"rgba(33, 81, 165, 1)"})})}),e.encmap.addInteraction(c),c.on("select",function(e){var t,r;null!=e.selected[0]&&(t=e.selected[0].getProperties().adcode,r=l.filter(function(e){if(e.attributes.code==t)return e.attributes.value}),o(r))})))}},EncMap.ENCAjax=function(){this.GET=function(e,t,r){axios({url:e,method:"GET",params:t||{}}).then(function(e){e.IS_SUCCESS=!0,e.SUCCESS_TEXT="æˆåŠŸ",r(e)}).catch(function(e){e.ISSUCCESS=!1,e.SUCCESS_TEXT="å¤±è´¥",r(e)})},this.POST=function(e,t,r){axios({url:e,method:"POST",dataType:"json",data:t||{}}).then(function(e){e.ISSUCCESS=!0,e.SUCCESS_TEXT="æˆåŠŸ",r(e)}).catch(function(e){e.ISSUCCESS=!1,e.SUCCESS_TEXT="å¤±è´¥",r(e)})},this.GETByGeoserver=function(e,t,r,n){axios({url:e,method:"GET",params:r||{},headers:t}).then(function(e){e.IS_SUCCESS=!0,e.SUCCESS_TEXT="æˆåŠŸ",n(e)}).catch(function(e){e.ISSUCCESS=!1,e.SUCCESS_TEXT="å¤±è´¥",n(e)})},this.POSTByGeoserver=function(e,t,r,n){axios({url:e,method:"POST",data:r||{},headers:t}).then(function(e){e.IS_SUCCESS=!0,e.SUCCESS_TEXT="æˆåŠŸ",n(e)}).catch(function(e){e.ISSUCCESS=!1,e.SUCCESS_TEXT="å¤±è´¥",n(e)})},this.PUTByGeoserver=function(e,t,r,n){axios({headers:{Authorization:"Basic YWRtaW46Z2Vvc2VydmVy","Content-Type":"application/zip"},url:e,method:"PUT",async:!1,processData:!1,data:r}).then(function(e){e.IS_SUCCESS=!0,e.SUCCESS_TEXT="æˆåŠŸ",n(e)}).catch(function(e){e.ISSUCCESS=!1,e.SUCCESS_TEXT="å¤±è´¥",n(e)})},this.pointQueryByWfs=function(e,t){e.tolerance||(e.tolerance=1);var r=Number(e.x)-Number(e.tolerance)+","+(Number(e.y)+Number(e.tolerance)),n=Number(e.x)-Number(e.tolerance)+","+(Number(e.y)-Number(e.tolerance)),o=Number(e.x)+Number(e.tolerance)+","+(Number(e.y)+Number(e.tolerance)),a=r+" "+n+" "+(Number(e.x)+Number(e.tolerance)+","+(Number(e.y)-Number(e.tolerance)))+" "+o+" "+r,i='<Filter xmlns="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml"><Intersects><PropertyName>'+e.field+"</PropertyName><gml:Polygon><gml:outerBoundaryIs><gml:LinearRing><gml:coordinates>"+a+"</gml:coordinates></gml:LinearRing></gml:outerBoundaryIs></gml:Polygon></Intersects></Filter>",l=e.url+"?service=WFS&version=1.0.0&request=GetFeature&typeName="+e.typename+"&outputFormat=application%2Fjson";l+="&filter="+i,axios({url:l,method:"GET"}).then(function(e){t(e)}).catch(function(e){t(e)})},this.queryWfsDataByPages=function(){},this.getPipeLength=function(e,o){axios({url:e.url,method:"GET"}).then(function(e){if(e.data){for(var t=e.data.features,r=[],n=0;n<t.length;n++)r.push({pipetype:t[n].properties.pipetype,pipelength:t[n].properties.pipelength});o(r)}}).catch(function(e){o(e)})},this.pointQueryByCircleWfs=function(e,t){e.tolerance||(e.tolerance=10);var r=ol.geom.Polygon.fromCircle(new ol.geom.Circle([Number(e.x),Number(e.y)],e.tolerance)),n=new ol.Feature({geometry:r}),o=" INTERSECTS(geom,"+(new ol.format.WKT).writeGeometry(n.getGeometry())+")",a=e.url+"?service=WFS&version=1.0.0&request=GetFeature&typeName="+e.typename+"&outputformat=json&maxFeature=50&"+parseInt(1e5*Math.random())+"&cql_filter="+o;axios({url:a,method:"get"}).then(function(e){e.IS_SUCCESS=!0,e.SUCCESS_TEXT="æˆåŠŸ",t(e)}).catch(function(e){e.ISSUCCESS=!1,e.SUCCESS_TEXT="å¤±è´¥",t(e)})},this.modifyFeature=function(e,t,r){var n=(new ol.format.WFS).writeTransaction(null,[t],null,{featureType:e.layername,featureNS:"gas",srsName:"EPSG:3857"}),o=(new XMLSerializer).serializeToString(n),a=e.url+"?service=WFS";axios({url:a,method:"post",data:o,headers:{"Content-Type":"text/xml"}}).then(function(e){e.IS_SUCCESS=!0,e.SUCCESS_TEXT="æˆåŠŸ",r("success")}).catch(function(e){e.ISSUCCESS=!1,e.SUCCESS_TEXT="å¤±è´¥",r("fail")})},this.transact=function(e,t,r,n,o){if(""!=e.layername){var a=new ol.format.WFS,i={featureType:e.layername,featureNS:e.featureNS,featurePrefix:e.featurePrefix,srsName:e.srsName},l=null;switch(r){case"insert":var s=n.getGeometry();if(n.set(e.field?e.field:"geometry",s),n.setGeometryName(e.field?e.field:"geometry"),t)for(var c in t)n.set(c,t[c]);l=a.writeTransaction([n],null,null,i);break;case"update":l=a.writeTransaction(null,[n],null,i);break;case"delete":l=a.writeTransaction(null,null,[n],i)}var u=(new XMLSerializer).serializeToString(l),m=e.url+"?service=WFS";axios({url:m,method:"post",data:u,headers:{"Content-Type":"text/xml"}}).then(function(e){e.IS_SUCCESS=!0,e.SUCCESS_TEXT="æˆåŠŸ",o("success")}).catch(function(e){e.ISSUCCESS=!1,e.SUCCESS_TEXT="å¤±è´¥",o("fail")})}}};var dragZoom=null;EncMap.EncControlProvider=function(){this.getZoomSlider=function(){return new ol.control.ZoomSlider({})},this.getScaleLine=function(e){var t=void 0,t=e||{};return new ol.control.ScaleLine({units:t.units||"metric",target:t.target||"",className:t.className||"ol-scale-line",minWidth:t.minWidth||64,bar:t.bar||!1})},this.getOverView=function(e){var t=void 0,t=e||{};return new ol.control.OverviewMap({className:t.className||"ol-overviewmap",collapsed:t.collapsed||!1,collapsible:t.collapsible||!1,layers:t.layers})},this.setZoomIn=function(e,t,r){var n;dragZoom=new ol.interaction.DragZoom({condition:ol.events.condition.always,out:!1}),t&&(dragZoom.box_.element_.className=t),e.encmap.addInteraction(dragZoom),dragZoom.setActive(!0),r&&(n="#"+(n=e.encmap.getTarget()),document.querySelector(n).style.cursor=r)},this.setZoomOut=function(e,t,r){var n;dragZoom=new ol.interaction.DragZoom({condition:ol.events.condition.always,out:!0}),t&&(dragZoom.box_.element_.className=t),e.encmap.addInteraction(dragZoom),dragZoom.setActive(!0),r&&(n="#"+(n=e.encmap.getTarget()),document.querySelector(n).style.cursor=r)},this.dragSpan=function(e){if(8<e.encmap.interactions.getArray().length)for(var t=8;t<=e.encmap.interactions.getArray().length;t++){var r=e.encmap.getInteractions().getArray()[t];r instanceof ol.interaction.Select||e.encmap.removeInteraction(r)}var n="#"+(n=e.encmap.getTarget());document.querySelector(n).style.cursor="default"},this.zoomToExtent=function(e){var t=void 0,t=e||{};return new ol.control.ZoomToExtent({className:t.className||"ol-zoom-extent",label:t.label||"E",tipLabel:t.tipLabel||"Fit to extent",extent:t.extent,target:t.target||null})},this.addControls=function(e,t){for(var r=0;r<t.length;r++)e.encmap.addControl(t[r])},this.zoomIn=function(e){var t=e.encmap.getView().getZoom();e.encmap.getView().setZoom(t+1)},this.zoomOut=function(e){var t=e.encmap.getView().getZoom();e.encmap.getView().setZoom(t-1)},this.removeDblClickInteraction=function(e){var t=e.encmap.getInteractions().getArray().find(function(e){return e instanceof ol.interaction.DoubleClickZoom});e.encmap.removeInteraction(t)},this.mousePosition=function(e){var t=void 0,t=e||{};return new ol.control.MousePosition({className:t.className||"ol-mouse-position",target:t.target||""})},this.Zoom=function(e){var t=void 0,t=e||{};return new ol.control.Zoom({duration:t.duration||250,className:t.className||"ol-zoom",target:t.target||""})},this.FullScreen=function(e){var t=void 0,t=e||{};return new ol.control.FullScreen({className:t.className||"ol-full-screen",target:t.target||""})},this.getControls=function(e){return e.encmap.getControls()},this.removeControl=function(e,t){e.encmap.removeControl(t)}},EncMap.ENCShortestPath=function(){this.showShortestPath=function(e,t,r,n,o){var a={LAYERS:r,FORMAT:"image/png"},i=["x1:"+n[0],"y1:"+n[1],"x2:"+o[0],"y2:"+o[1]];a.viewparams=i.join(";");var l=new ol.layer.Image({source:new ol.source.ImageWMS({url:t,params:a})});return l.set("layerId",r),l}},EncMap.EncCoordtransTools=function(){var w=3.141592653589793,S=6378245,M=.006693421622965943;this.gpsto3857=function(e,t){var r,n,o,a,i,l,s,c,u,m,y=(o=2*(r=e-105)-100+3*(n=t-35)+.2*n*n+.1*r*n+.2*Math.sqrt(Math.abs(r)),o+=2*(20*Math.sin(6*r*w)+20*Math.sin(2*r*w))/3,o+=2*(20*Math.sin(n*w)+40*Math.sin(n/3*w))/3,o+=2*(160*Math.sin(n/12*w)+320*Math.sin(n*w/30))/3),g=(l=300+(a=e-105)+2*(i=t-35)+.1*a*a+.1*a*i+.1*Math.sqrt(Math.abs(a)),l+=2*(20*Math.sin(6*a*w)+20*Math.sin(2*a*w))/3,l+=2*(20*Math.sin(a*w)+40*Math.sin(a/3*w))/3,l+=2*(150*Math.sin(a/12*w)+300*Math.sin(a/30*w))/3),f=t/180*w,p=Math.sin(f),p=1-M*p*p,d=Math.sqrt(p),y=180*y/(S*(1-M)/(p*d)*w),g=180*g/(S/d*Math.cos(f)*w),h=Number(t)+Number(y),v=Number(e)+Number(g);return s=h,c=v*Math.PI/180*6378137,u=s*Math.PI/180,m=3189068.5*Math.log((1+Math.sin(u))/(1-Math.sin(u))),{x:c,y:m}}},EncMap.ENCArcGISQuery=function(){this.identifyTask=function(e,t,r,n,o,a){var i="{'x':"+r+",'y':"+n+"}",l=t+"/identify",s=e.encmap.getView().calculateExtent(e.encmap.getSize()),c=window.screen.width+","+window.screen.height+","+function(){var e=new Array;{var t;null!=window.screen.deviceXDPI?(e[0]=window.screen.deviceXDPI,e[1]=window.screen.deviceYDPI):((t=document.createElement("DIV")).style.cssText="width:1in;height:1in;position:absolute;left:0px;top:0px;z-index:99;visibility:hidden",document.body.appendChild(t),e[0]=parseInt(t.offsetWidth),e[1]=parseInt(t.offsetHeight),t.parentNode.removeChild(t))}return e[0]}(),u={f:"json",geometry:i,geometryType:"esriGeometryPoint",spatialRel:"esriSpatialRelIntersects",returnGeometry:"true",tolerance:o||10,outFields:"*",layers:"all",mapExtent:s.toString(),imageDisplay:c};axios({url:l,method:"POST",dataType:"json",data:u,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},transformRequest:[function(e){var t="";for(var r in e)t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r])+"&";return t}]}).then(function(e){a(e)}).catch(function(e){a(e)})},this.queryTask=function(e,t,r){var n=t.url+"/"+t.layerId+"/query",o=null,a=null;t.geometry&&(o=t.geometry,a=t.geometryType);var i={f:"json",geometry:o,geometryType:a,spatialRel:"esriSpatialRelIntersects",returnGeometry:"true",outFields:"*",where:t.where?t.where:"1=1",inSR:3857,distance:100};axios({url:n,method:"POST",dataType:"json",data:i,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},transformRequest:[function(e){var t="";for(var r in e)t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r])+"&";return t}]}).then(function(e){r(e)}).catch(function(e){r(e)})},this.featureFromEsri=function(e){return(new ol.format.EsriJSON).readFeatures(e)}};